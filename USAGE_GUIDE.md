# MCP AI Commit - Global Usage Guide

## üéØ Overview

MCP AI Commit is a global Model Context Protocol (MCP) server that provides automatic provenance tracking for all AI-generated commits. When integrated with Claude Code, it automatically:

1. **Tracks all prompts** sent to AI models for commit generation
2. **Stores complete prompt/response pairs** with unique execution IDs
3. **Appends AI footer** to commits for transparency
4. **Validates file scope** using allowed path patterns
5. **Provides complete audit trail** for all AI-assisted commits

## üöÄ Quick Start

### 1. Installation

```bash
# Clone the repository
git clone https://github.com/beedev/MCP-Provenance.git
cd MCP-Provenance

# Install globally
pip install -e .
```

### 2. Configuration

Copy and configure the environment file:

```bash
cp .env.example .env
# Edit .env with your settings
```

Required configuration:
```env
# Database (PostgreSQL required)
DATABASE_URL=postgresql://postgres@localhost:5432/pconfig
DATABASE_SCHEMA=ai_commit

# AI Model API Keys
OPENAI_API_KEY=your_openai_key_here
ANTHROPIC_API_KEY=your_anthropic_key_here

# Server Configuration
MCP_SERVER_PORT=8081
LOG_LEVEL=INFO
```

### 3. Start the Global MCP Server

```bash
# Start the server (runs globally for all projects)
python -m mcp_ai_commit.server --port 8081
```

The server will run in the background and handle all AI commit requests.

## üîß Claude Code Integration

### Automatic Integration

When the MCP server is running, Claude Code will automatically use it for commit generation:

1. **Stage your files** as usual: `git add .`
2. **Request AI commit** through Claude Code: "Generate a commit message for these changes"
3. **MCP server intercepts** the request automatically
4. **Full provenance** is stored with unique execution ID
5. **AI footer** is appended to commit message

### Example Workflow

```bash
# 1. Make your changes
echo "console.log('Hello World');" > hello.js

# 2. Stage files
git add hello.js

# 3. Ask Claude Code to generate commit
# "Generate a conventional commit for this new JavaScript file"

# 4. Claude Code + MCP generates:
#    feat: add hello world JavaScript file
#    
#    Adds a simple hello world script demonstrating 
#    basic JavaScript console output functionality.
#    
#    ü§ñ AI-Generated Commit (exec_id: 12cc85f9-94e9-4842-aa26-3430e1973c40)
#    Generated by: openai/gpt-4
#    Strategy: conventional
#    Timestamp: 2025-10-05T16:45:00.000Z
```

## üõ°Ô∏è File Scope Validation

### Allowed Paths Configuration

Configure which files AI can modify using glob patterns:

```bash
# Allow specific files
--allowed-paths "*.js,*.ts,src/**,README.md"

# Deny sensitive files (automatically blocked)
# - .env files
# - Private keys (*.key, *.pem)  
# - Configuration files outside src/
# - Database files
```

### Security Features

- ‚úÖ **Path validation** prevents AI from modifying sensitive files
- ‚úÖ **Automatic blocking** of security-sensitive patterns
- ‚úÖ **Audit trail** of all attempted file modifications
- ‚úÖ **Git state validation** ensures clean repository state
- ‚úÖ **Permissions checking** validates write access

## üìä Provenance Tracking

### What Gets Tracked

Every AI commit generation stores:

```json
{
  "exec_id": "12cc85f9-94e9-4842-aa26-3430e1973c40",
  "timestamp": "2025-10-05T16:45:00.000Z",
  "repo_path": "/Users/user/project",
  "branch_name": "main",
  "commit_hash": "abc123def456",
  "model_provider": "openai",
  "model_name": "gpt-4",
  "prompt_text": "Generate conventional commit for...",
  "response_text": "feat: add hello world file...",
  "commit_message": "Complete final commit message",
  "files_changed": ["hello.js"],
  "execution_successful": true,
  "performance_metrics": {
    "prompt_tokens": 45,
    "completion_tokens": 23,
    "execution_time_ms": 1500
  }
}
```

### Querying Provenance Data

```bash
# Get execution history for current repository
mcp-ai-commit history --repo-path .

# Get specific execution details
mcp-ai-commit history --exec-id 12cc85f9-94e9-4842-aa26-3430e1973c40

# Repository statistics
mcp-ai-commit stats --repo-path .
```

## üéõÔ∏è Advanced Configuration

### Multiple AI Providers

```env
# Support both OpenAI and Anthropic
OPENAI_API_KEY=your_openai_key
ANTHROPIC_API_KEY=your_anthropic_key

# Default provider
DEFAULT_MODEL_PROVIDER=openai
DEFAULT_MODEL_NAME=gpt-4
```

### Commit Strategies

- **conventional**: Conventional Commits format
- **semantic**: Semantic versioning aware
- **natural**: Natural language descriptions
- **custom**: User-defined templates

### Security Levels

- **strict**: Only allowed paths, reject violations
- **warn**: Allow but warn on violations  
- **permissive**: Log violations but allow

## üîç Monitoring & Debugging

### Check Server Status

```bash
# Verify server is running
curl http://localhost:8081/health

# Check database connection
mcp-ai-commit config test
```

### View Logs

```bash
# Server logs
tail -f ~/.mcp-ai-commit/logs/server.log

# Database operations
tail -f ~/.mcp-ai-commit/logs/database.log
```

### Common Issues

1. **Port already in use**: Change `MCP_SERVER_PORT` in `.env`
2. **Database connection failed**: Verify PostgreSQL is running
3. **API key invalid**: Check OpenAI/Anthropic API keys
4. **Permission denied**: Ensure write access to git repository

## üåç Multi-Project Usage

The MCP server runs globally and handles multiple projects:

```bash
# Server handles all projects automatically
cd /project1 && git add . && ask Claude for commit
cd /project2 && git add . && ask Claude for commit  
cd /project3 && git add . && ask Claude for commit

# Each project gets separate provenance tracking
# All data stored in central database with repo_path distinction
```

## üìà Usage Analytics

View usage across all projects:

```sql
-- Connect to database
psql postgresql://postgres@localhost:5432/pconfig

-- View recent AI commits across all projects
SELECT repo_path, branch_name, model_provider, 
       DATE_TRUNC('day', timestamp) as day,
       COUNT(*) as commits
FROM ai_commit.ai_commit_executions 
WHERE timestamp > NOW() - INTERVAL '30 days'
GROUP BY repo_path, branch_name, model_provider, day
ORDER BY day DESC;

-- Success rates by model
SELECT model_provider, model_name,
       COUNT(*) as total,
       SUM(CASE WHEN execution_successful THEN 1 ELSE 0 END) as successful,
       ROUND(100.0 * SUM(CASE WHEN execution_successful THEN 1 ELSE 0 END) / COUNT(*), 2) as success_rate
FROM ai_commit.ai_commit_executions
GROUP BY model_provider, model_name;
```

## ü§ù Integration Examples

### With Pre-commit Hooks

```bash
# .pre-commit-config.yaml
repos:
  - repo: local
    hooks:
      - id: ai-commit-validation
        name: AI Commit Validation
        entry: mcp-ai-commit validate
        language: system
        stages: [commit-msg]
```

### With CI/CD

```yaml
# .github/workflows/commit-validation.yml
name: Validate AI Commits
on: [push]
jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Validate AI Commit Provenance
        run: |
          mcp-ai-commit validate --commit ${{ github.sha }}
```

## üéâ Success!

Your MCP AI Commit system is now configured for global usage across all projects. Every AI-generated commit will automatically include:

- ‚úÖ Complete provenance tracking
- ‚úÖ Unique execution IDs
- ‚úÖ Full prompt/response storage
- ‚úÖ File scope validation
- ‚úÖ Transparent AI footers

Ready to track all AI-assisted commits with full transparency!